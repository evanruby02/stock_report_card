import pandas as pd


def grade_reportcard(metrics: dict) -> tuple[dict, int]:
    scores = {}

    def to_decimal(value):
        if value is None:
            return 0.0
        if isinstance(value, str):
            value = value.strip().replace("%", "")
            try:
                value = float(value)
            except ValueError:
                return 0.0
        return value / 100 if value > 1 else value

    cash_to_debt = metrics.get("Cash Flow to Debt Ratio") or 0.0
    rev_growth = to_decimal(metrics.get("Revenue Growth"))
    op_margin = to_decimal(metrics.get("Operating Margin"))
    short_interest_ratio = to_decimal(metrics.get("Short Interest Ratio"))
    inst_own = to_decimal(metrics.get("Institutional Investment %"))
    scalability = metrics.get("Scalability") or 0.0
    shareholder_return = metrics.get("Relative 5Y Return")

    if shareholder_return is None:
        shareholder_return = 0.0
    elif isinstance(shareholder_return, str):
        try:
            shareholder_return = float(
                shareholder_return.strip().replace("%", ""))
        except ValueError:
            shareholder_return = 0.0
    if shareholder_return > 1:
        shareholder_return = shareholder_return / 100

    # 1. Cash to Debt
    if cash_to_debt < 1:
        scores["Cash to Debt"] = 0
    elif 1 <= cash_to_debt < 2:
        scores["Cash to Debt"] = 5
    else:
        scores["Cash to Debt"] = 10

    # 2. Revenue Growth %
    if rev_growth < 0.0010:
        scores["Revenue Growth"] = 0
    elif 0.0010 <= rev_growth < 0.0020:
        scores["Revenue Growth"] = 5
    else:
        scores["Revenue Growth"] = 10

    # 3. Operating Margin
    if op_margin < 0.10:
        scores["Operating Margin"] = 0
    elif 0.10 <= op_margin < 0.25:
        scores["Operating Margin"] = 5
    else:
        scores["Operating Margin"] = 10

    # 4. Short Interest Ratio
    if short_interest_ratio >= 0.10:
        scores["Short Interest Ratio"] = 0
    elif 0.05 <= short_interest_ratio < 0.10:
        scores["Short Interest Ratio"] = 5
    else:
        scores["Short Interest Ratio"] = 10

    # 5. Institutional Ownership %
    if inst_own < 0.30:
        scores["Institutional Ownership"] = 0
    elif 0.30 <= inst_own < 0.60:
        scores["Institutional Ownership"] = 5
    else:
        scores["Institutional Ownership"] = 10

    # 6. Scalability
    scores["Scalability"] = 10 if scalability > 1 else 0

    # 7. Shareholder Treatment (relative 5yr return)
    if shareholder_return < 0:
        scores["Shareholder Treatment"] = 0
    elif 0 <= shareholder_return < 0.10:
        scores["Shareholder Treatment"] = 5
    else:
        scores["Shareholder Treatment"] = 10

    total_score = sum(scores.values())
    return scores, total_score


def append_scores_to_df(df: pd.DataFrame, scores: dict) -> pd.DataFrame:
    # Create a dict for the new row with blanks for non-score columns
    score_row = {
        "Date": "",
        "Ticker": "",
        "5Y Stock Return": "",
        "5Y S&P 500 Return": "",
    }

    # Map score keys to DataFrame column names
    col_map = {
        "Cash to Debt": "Cash Flow to Debt Ratio",
        "Revenue Growth": "Revenue Growth",
        "Operating Margin": "Operating Margin",
        "Short Interest Ratio": "Short Interest Ratio",
        "Institutional Ownership": "Institutional Investment %",
        "Scalability": "Scalability",
        "Shareholder Treatment": "Relative 5Y Return",
    }

    # Fill the score values in the corresponding columns
    for key, col_name in col_map.items():
        score_row[col_name] = scores.get(key, "")

    # Fill blanks for any other columns
    for col in df.columns:
        if col not in score_row:
            score_row[col] = ""

    # Append score row to DataFrame
    score_df = pd.DataFrame([score_row])
    return pd.concat([df, score_df], ignore_index=True)
